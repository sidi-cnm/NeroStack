

# Définition du réseau privé pour l'ensemble des conteneurs
# Ce réseau n'est pas accessible de l'extérieur du serveur (isolation)
networks:
  mayan_connect_network:
    driver: bridge # Type de réseau privé Docker

# Services de l'application
services:

  # 1. Base de Données (PostgreSQL) - Partagée entre Mayan et Backend
  db:
    image: postgres:13-alpine
    container_name: mayan_db
    environment:
      POSTGRES_DB: mayan_db
      POSTGRES_USER: mayan
      POSTGRES_PASSWORD: ${MAYAN_DB_PASSWORD:-mayan_default_password}
      # Base de données supplémentaire pour le backend
      POSTGRES_MULTIPLE_DATABASES: nerostack_db
    volumes:
      - ./data/db:/var/lib/postgresql/data
      - ./backend/init-db.sh:/docker-entrypoint-initdb.d/init-db.sh:ro
    networks:
      - mayan_connect_network
    restart: always
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U mayan -d mayan_db"]
      interval: 10s
      timeout: 5s
      retries: 5

  # 2. Mayan EDMS - Le Moteur Documentaire (Data)
  mayan:
    image: mayanedms/mayanedms:latest
    container_name: mayan_edms
    environment:
      # Connexion à la base de données via le nom du service (db) sur le réseau privé
      MAYAN_DATABASE_ENGINE: django.db.backends.postgresql
      MAYAN_DATABASE_NAME: mayan_db
      MAYAN_DATABASE_USER: mayan
      user: "1000:1000"
      MAYAN_DATABASE_PASSWORD: ${MAYAN_DB_PASSWORD:-mayan_default_password}
      MAYAN_DATABASE_HOST: db
      MAYAN_BROKER_URL: redis://redis:6379/0
      MAYAN_CACHE_BACKEND: django.core.cache.backends.locmem.LocMemCache
      MAYAN_DATABASE_PORT: 5432
      CELERY_RESULT_BACKEND: redis://redis:6379/1
    # NOTE: Pour la production, l'accès à l'interface native de Mayan devrait être contrôlé
    # Ici, on expose le port 8000 pour les tests et le SSO (Grand Bonus)
    ports:
      - "8001:8000"
    volumes:
      - ./data/mayan:/var/lib/mayan
    networks:
      - mayan_connect_network
    depends_on:
      - db
      - redis
    restart: always

  # 3. Backend Flask - Gestion de l'Authentification et Accès Temporaire (Auth)
  backend:
    build:
      context: ./backend
      dockerfile: dockerfile
    container_name: nerostack_backend
    environment:
      FLASK_ENV: development
      SECRET_KEY: ${SECRET_KEY:-dev-secret-key-change-in-production}
      JWT_SECRET_KEY: ${JWT_SECRET_KEY:-jwt-secret-key-change-in-production}
      # Connexion à PostgreSQL (même conteneur que Mayan)
      DATABASE_URL: postgresql://nerostack:nerostack_password@db:5432/nerostack_db
      MAYAN_URL: http://mayan:8000
      MAYAN_ADMIN_USER: ${MAYAN_ADMIN_USER:-admin}
      MAYAN_ADMIN_PASSWORD: ${MAYAN_ADMIN_PASSWORD:-admin}
      OLLAMA_URL: http://service_ia_locale:11434
      OLLAMA_MODEL: ${OLLAMA_MODEL:-llama3.2}
      CORS_ORIGINS: http://localhost:3000,http://votre_client:3000
    ports:
      - "8080:8080"
    volumes:
      - ./backend:/app
    networks:
      - mayan_connect_network
    depends_on:
      db:
        condition: service_healthy
      mayan:
        condition: service_started
      ia_locale:
        condition: service_started
    restart: always
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/api/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s

  # 4. Votre Client - Interface Utilisateur (Web/Mobile)
  # Ce service sera développé par le Membre 3
  client:
    build:
      context: ./client # Le chemin vers votre code source client (ex: React/Vue/Flutter)
    container_name:  votre_client
    # Le seul service directement accessible par l'utilisateur final sur Internet (réseau public)
    ports:
      - "3000:3000"
    volumes:
      - ./client:/app
      - /app/.next
    networks:
      - mayan_connect_network
    depends_on:
      - backend # Dépend du Backend pour l'authentification
    restart: always

  # 5. Service IA Locale - Moteur d'Analyse (Intelligence)
  # Ce service sera mis en place par le Membre 4

  # 5. Service IA Locale - Moteur d'Analyse (Intelligence)
  ia_locale:
    image: ollama/ollama:latest
    container_name: service_ia_locale
    # La ligne 'ports' DOIT ÊTRE SUPPRIMÉE pour garantir l'isolation.
    #
    volumes:
      - ./data/ollama:/root/.ollama
    networks:
      - mayan_connect_network # Reste connecté uniquement au réseau interne.
    restart: always


  redis:
    image: redis:6-alpine
    container_name: mayan_redis
    networks:
      - mayan_connect_network
    restart: always
